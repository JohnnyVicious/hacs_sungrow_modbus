name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

env:
  COMPONENT_NAME: sungrow_modbus

jobs:
  release:
    name: Prepare release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Extract version from release tag (remove 'v' prefix if present)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            # Use manual input version
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Update manifest.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd custom_components/${{ env.COMPONENT_NAME }}
          # Update version in manifest.json
          jq ".version = \"$VERSION\"" manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json
          echo "Updated manifest.json to version $VERSION"
          cat manifest.json

      - name: Create zip package
        run: |
          cd custom_components/${{ env.COMPONENT_NAME }}
          zip -r ${{ env.COMPONENT_NAME }}.zip ./*
          echo "Created ${{ env.COMPONENT_NAME }}.zip"
          ls -la *.zip

      - name: Upload release asset (on release event)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: custom_components/${{ env.COMPONENT_NAME }}/${{ env.COMPONENT_NAME }}.zip
          tag_name: ${{ github.event.release.tag_name }}

      - name: Create release (on workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: custom_components/${{ env.COMPONENT_NAME }}/${{ env.COMPONENT_NAME }}.zip
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          draft: false
